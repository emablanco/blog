---
layout: single
title: GRUPOS DE CONTROL - CGROUP

excerpt: "En esta oportunidad, planeo implementar limitaciones para prevenir el uso excesivo de recursos del sistema por parte de usuarios específicos mediante el uso de Cgroups."


date: 2023-09-11
classes: wide
header:
    teaser: ../assets/images/cgroup/logo.jpg
    teaser_home_page: true
    icon: ../assets/images/logofairy.png
categories:
    - GNU/Linux
tags:  
    - systemd
---
<p align="center">
  <img src="../assets/images/cgroup/wallpapers.png">
</p>

## ¿Que es cgroup?

Cgroups es una característica de Linux que permite controlar y limitar el consumo de recursos como CPU, memoria, E/S, etc, garantizando un uso eficiente de los recursos del sistema entre múltiples usuarios o procesos. Esta medida busca mejorar el rendimiento y la estabilidad del sistema al evitar que un usuario acapare todos recursos, lo que a su vez beneficia a otros usuarios y aplicaciones en el mismo entorno compartido.


## Configuración

###  cgroup v2
A partir de Debian 11 Bullseye (2021), Debian utiliza jerarquía de grupos unificados (a.k.a. cgroups-v2). Entonces no es necesario instalar los paquetes cgroup-tools y libcgroup2, ya que las herramientas relacionadas con Cgroups v2 están preinstaladas y funcionando correctamente.

[fuente](https://www.debian.org/doc/manuals/debian-reference/ch04.es.html#_linux_security_features)

Pero si por alguna razon no se encuentran en el sistema se pueden instalar de la siguiente manera: 

```bash
apt update
apt install cgroup-tools libcgroup2

```

- **cgroup-tools:** Este paquete incluye las utilidades de línea de comandos que permiten interactuar con cgroups de manera directa y realizar tareas como la creación de cgroups, configuración de límites de recursos y la supervisión de procesos dentro de cgroups.  

   - cgcreate, cgset, cgexec, cgclassify, etc.

- **libcgroup2:** Este paquete contiene la biblioteca libcgroup, que proporciona una interfaz de programación para trabajar con cgroups desde aplicaciones y scripts. 


### D-bus 

Instalación de **dbus-user-session**.  Cuando se instala este paquete,se esta instalando el sistema **D-Bus** para la sesión del usuario en el sistema.

```bash

apt install -y dbus-user-session
systemctl --user start dbus

```

dbus-user-session o **D-Bus** es un sistema de comunicación entre procesos que permite que aplicaciones en un sistema Linux se comuniquen entre sí. El paquete **dbus-user-session** proporciona el sistema de **D-Bus** para sesiones de usuario, lo que significa que habilita la comunicación entre las aplicaciones que se ejecutan en la sesión de un usuario específico.

- **systemctl --user start dbus:** Una vez que se instalo **dbus-user-session**, se necesita iniciar el servicio **D-Bus** para que las aplicaciones en la sesión de usuario puedan utilizarlo para la comunicación entre procesos.


Habilitar D-bus para todos los usuarios del sistema: 

```bash
systemctl enable dbus
systemctl start dbus

```
### Cgroup v2 

De forma predeterminada, en muchos sistemas Linux, solo los controladores memory y pids se delegan a usuarios no root en cgroups. Esto significa que los usuarios no root pueden controlar y configurar límites de recursos relacionados con la memoria y el número de procesos que pueden crear, pero no se les permite controlar otros controladores, como los relacionados con la CPU o los dispositivos.

La razón de esta limitación es por seguridad. Los controladores de cgroups ofrecen un control detallado sobre los recursos del sistema, es por esta razon que no se deja en manos de cualquier usuarios el control completo sobre todos los controladores.


- A usuarios no root solo se le delegan memory y pids:

1. **Memory (Memoria):** Controlar la cantidad de memoria RAM que sus procesos pueden consumir. 

1. **Pids (Procesos):** Limitar la cantidad de procesos que se pueden iniciar.


- Para permitir la delegación de otros controladores, se debe cambiar la configuración de systemd de la siguiente manera:

```bash

 mkdir -p /etc/systemd/system/user@.service.d

 cat > /etc/systemd/system/user@.service.d/cgroup-defaul.conf << EOF

 [Service]

 Delegate=cpu cpuset io memory pids

 EOF

 systemctl daemon-reload

```

Esto permite que cada usuario que haga loggin en el sistema pueda hacer uso de los controladores **CPU, CPUSET, IO, MEMORY,PIDS**.

 - cpu: Permite controlar y limitar el uso del CPU .
 - cpuset: Permite controlar la asignacion de nucleos a procesos (podemos definir en que nucleo se ejecutara un proceso)
 - io: Permite administrar el acceso de E/S al disco.
 - memory: Permite controlar y limitar el uso de la memoria RAM
 - pips: Permite administrar el numero maximo de procesos que pueden ser creados.


### USER-SLICE 

El archivo que utiliza systemd para crear los user.slice se encuentra en la ruta _/usr/lib/systemd/user-.slicer.d/_ y no debe ser modificado.

Ver su contenido: 

```bash

cat /usr/lib/systemd/system/user-.slice.d/10-defaults.conf 

```
El archivo **10-defaults.conf** configura las opciones predeterminadas para todas las **Slices** de Usuario generadas automáticamente por systemd. Modificar este archivo podría afectar a todos los usuarios en el sistema y no se recomienda. En su lugar, se recomienda crear archivos de configuración personalizados en el directorio _/etc/systemd/system/user@.service.d/_ para realizar configuraciones específicas para usuarios individuales, las culaes se aplicarán solo a los servicios systemd de los usuarios seleccionados.

Cada usuario que se loguea tiene su propio servicio systemd **user@UID.service**, donde UID es el identificador único del usuario. Se Pueden crear archivos de configuración personalizados dentro de _/etc/systemd/system/user@.service.d/_ para ajustar la configuración de recursos y controladores de cgroups para usuarios específicos de manera más precisa sin afectar a otros usuarios del sistema.

- en _/etc/systemd/system/user@.service.d/_: Se colocan las configuraciones que se aplicarán de manera predeterminada a todos los usuarios que se logueen al sistema. Cualquier archivo de configuración que se coloque aquí afectará a todas las instancias de servicios de usuario generadas automáticamente por systemd.

- en _/etc/systemd/system/user-UID.service.d/_: Se puede crear un directorio con el UID del usuario que se pretende controlar, y dentro del directorio colocar las configuraciones específicas que se aplicarán solo a ese usuario. Los archivos de configuración que se coloquen aquí solo afectarán a la instancia de servicio del usuario con UID definido (user-UID.service).

Al organizar las configuraciones de esta manera, se pueden personalizar las opciones para usuarios individuales sin afectar a otros usuarios en el sistema. Esto permite una gran flexibilidad en la administración de recursos y la configuración de servicios para usuarios específicos.


Se pueden almacenar varios archivos de configuración personalizados dentro del directorio _/etc/systemd/system/user-UID.service.d/. No hay un límite específico en la cantidad de archivos que se pueden tener en ese directorio. Cada archivo de configuración personalizado puede contener configuraciones específicas que afectarán a la instancia del servicio systemd del usuario con UID definido.

Cuando se tengan múltiples archivos de configuración personalizados en el directorio _/etc/systemd/system/user-UID.service.d/_, systemd los aplicará en el orden alfabético, por lo se que puede ajustar el orden para garantizar que las configuraciones se apliquen de la manera deseada.

- Ejemplo de una posible configuracion: 

```bash
[Service]
Delegate=cpu cpuset io memory pids
ExecStartPre=/ruta/al/script-de-configuracion.sh

```

## RESUMEN DE LA CONFIGURACION


### INSTALACIÓN 

Para instalar y configurar Cgroups v2 en Debian y gestionar los recursos de hardware para cada usuario se deben seguir estos pasos:

- Actualizar lista de paquetes

```bash

#Agregar repositorio debian 12
echo "deb http://ftp.de.debian.org/debian bookworm main" >> /etc/apt/sources.list

#actualizar los repositorios
apt update

```
<p align="center">
  <img src="../assets/images/cgroup/mv.png">
</p>


- Instalar paquetes necesarios

```bash

apt install cgroup-tools libcgroup2

```

- Instalar D-Bus: esto podría ser necesario en algunas configuraciones.

```bash

sudo apt install -y dbus-user-session

```

- Iniciar el servicio dbus-user-session:

```bash

#este comando es cuando solo se quiere habiliatar para el usuario en sesion.
systemctl --user start dbus

# habiliatar para todos los usuarios 

systemctl start dbus 
systemctl enable dbus
```

- Crea un archivo de configuración para Cgroups:  En este caso creare un archivo en el directorio _/etc/systemd/system/user@.service.d/_ para configurar las restricciones de recursos para los usuarios que inician sesión.

```bash

vi /etc/systemd/system/user@.service.d/cgrup-dafault.conf

```
- Agregar las siguientes configuraciones de Cgroups al archivo _cgroup-default.conf_. Por ejemplo, para limitar el uso de CPU, conjuntos de CPU, E/S de disco, memoria y procesos, puedes usar lo siguiente:

plaintext

```bash

[Service]

Delegate=cpu cpuset io memory pids
ExecStartPre=/ruta/al/script-de-configuracion.sh
```

- Recarga la configuración de systemd para que las nuevas configuraciones tengan efecto:

```bash

systemctl daemon-reload

```

- Reiniciar el servicio de inicio de todos los usuarios para aplicar las restricciones de recursos:

```bash

systemctl --user restart user@.service

```

Con estos pasos, se tendra configurado Cgroups v2 para limitar el uso de recursos de hardware a todos los usuarios que inicien sesión en el sistema.


