---
layout: single

title: Servidor Samba AD - GNU/Linux

excerpt: "**Controlador de dominio con Samba**. Este 
permitirá unir estaciones de trabajo en Windows como en GNU/Linux para poder gestionar de una forma centralizada los equipos, grupos y usuarios de la red LAN, además de poder generar políticas de seguridad globales e individuales."

date: 2022-08-07

classes: wide

header:

    teaser: /assets/images/samba/logo.png

    teaser_home_page: true
    
    icon: /assets/images/logofairy.png

categories:

    - Samba
    - Active Directory server
    - Linux
    
tags:  

- Samba Active Directory server
---


![](/assets/images/samba/wallpapers.png)


Para este ejemplo estare usando utilizando DEBIAN 11 en mi servidor de virtualización QEMU/KVM.

Los datos del servidor para la entrada son los siguientes y recuerde ajustarlos a su necesidad:

* **Nombre del servidor:** servidor
* **Dirección IP:** 192.168.1.3/24

![](/assets/images/samba/hosts.png)

El servidor DNS definido debe ser uno real que permita acceder a internet. Una vez finalizada la instalación se debe declarar como DNS principal el servidor samba: 127.0.0.1.

## AACTULIZAR SISTEMA

Es necesario que el sistema se encuentre actualzado:

```bash
apt update
apt upgrade
```

## INSTALACIÓN

Instalar las dependecias necesarias:

[Dependencias](https://wiki.samba.org/index.php/Distribution-specific_Package_Installation#Debian)

* **NOTA:** durante el proceso de instalación se solicitara información para la configuración de kerberos. En este caso solo presionare enter y dejare todo por defecto. Las configuraciones las realizare luego.

```bash
apt install acl attr samba samba-dsdb-modules samba-vfs-modules winbind libpam-winbind libnss-winbind libpam-krb5 krb5-config krb5-user
```

![](/assets/images/samba/kerberos1.png)

Finalizada la instalación es necesario borrar o renombrar el archivo smb.conf que se crea por defecto durante la instalación.

```bash
mv /etc/samba/smb.conf /etc/samba/smb.conf.back
```
Ahora es momenrto de confugurar **SAMBA**.

![](/assets/images/samba/samba-tool.png)

```bash
root@servidor:~# samba-tool domain provision --use-rfc2307 --interactive
```

Nombre del Realm: a modo de ejemplo lo llamare ema.local

Los dominios local deben seguir con un **_.local_**. Porque es un dominio dentro de la red local.

```bash
Realm:  ema.local
```
Detectará automáticamente el dominio, así que simplemente damos ENTER.

```bash
Domain [ema]:  
```
Configurar como role DC el cual quiere decir Controlador de dominio. Presionar ENTER.

```bash
Server Role (dc, member, standalone) [dc]:  
```
Configurar el modo en que se gestionarán los registros DNS. Si no se cuenta con ningún servidor DNS, por defecto se debe dejar **SAMBA\_INTERNAL**. 

```bash
DNS backend (SAMBA_INTERNAL, BIND9_FLATFILE, BIND9_DLZ, NONE) [SAMBA_INTERNAL]:
```  
DNS forwader pregunta cuál es la dirección IP del servidor DNS que va a resolver las consultas que Samba no pueda gestionar. O sea, el servidor que responderá a todas las consultas que no sea **_ema.local_**.

```bash
DNS forwarder IP address (write 'none' to disable forwarding) [192.168.1.1]: 
```
Establecer una contraseña para el usuario administrator. La cual debe estar compuestas por minúsculas, mayúsculas y números.

``` 
Administrator password: 
Retype password: 
```

Archivo de configuracion de **SAMBA**.

![](/assets/images/samba/smb.png)

Por defecto kerberos crea su archivo de configuración en /etc/ el cual se debe eliminar, en su lugar se usara el generado por samba.

```bash
mv /etc/krb5.conf /etc/krb5.conf.back
cp /var/lib/samba/private/krb5.conf /etc/
```

Deshabilitar los servicios que se crearon hace momento y habilitar el servicio de **samba-ad-dc**. 

```bash
systemctl disable --now smbd nmbd winbind systemd-resolved
systemctl unmask samba-ad-dc
systemctl enable --now samba-ad-dc
```
![](/assets/images/samba/servicio.png)

Ver el nivel de funcionalidad del controlador:

```bash
samba-tool domain level show
```
![](/assets/images/samba/show.png)


## RESOLV

El archivo _/etc/resolv.conf_ debe quedar de la siguiente manera:

```bash
root@servidor:~# cat /etc/resolv.conf 
domain ema.local
search ema.local
nameserver 192.168.1.3
```

* Comprobar que el servicio responde:

```bash
smbclient -L localhost -U%

ping -c2 ema.local
ping -c2 servidor.ema.local


host -t A ema.local
ema.local has address 192.168.1.3

# host -t A servidor.ema.local
servidor.ema.local has address 192.168.1.3

# host -t SRV _kerberos._udp.ema.local
_kerberos._udp.ema.local has SRV record 0 100 88 servidor.ema.local.

# host -t SRV _ldap._tcp.networld.cu
_ldap._tcp.ema.local has SRV record 0 100 389 servidor.ema.local.
```

![](/assets/images/samba/check.png)

## CREAR USUARIOS

```bash
useradd ema
useradd ale
```

## AGREGAR USUARIOS A SAMBA:

Para agregar los usuarios anteriormente creados a **SAMBA** se puede hacer de dos maneras, con el comando _smbpasswd_ o __pdbedit_.

```bash
pdbedit -a ema
pdbedit -a ale
```
![](/assets/images/samba/passwd.png)

## ESTADO DE LA CUENTA ADMINISTRADOR

* Verificar el estado de la cuenta administrador:

```bash
kinit administrator@ema.local
klist
```

* verificar si la autentificación está funcionand

```bash
smbclient //localhost/netlogon -Uadministrator -c 'ls'
```
## INTEGRAR EQUIPOS WINDOWS 10 A DOMINIO DE SAMBA:

Configurar servidor DNS

![](/assets/images/samba/win10-1.png)

Introducir windows al dominio **ema.local**.

* Ingresar Dominio: 

![](/assets/images/samba/win10-2.png)

* Ingresar credenciales del administrador:

![](/assets/images/samba/win10-3.png)

* Reiniciar:

![](/assets/images/samba/win10-4.png)

* Login:
 
![](/assets/images/samba/ema.png)

* Usuario ema:

![](/assets/images/samba/ema-1.png)

# INTEGRAR EQUIPOS WINDOWS 7 A DOMINIO DE SAMBA:

Introducir windows al dominio **ema.local**.

* Ingresar Dominio: 

![](/assets/images/samba/win7-1.png)

* Cambio de dominio:

![](/assets/images/samba/win7-2.png)

* Ingresar credenciales del Administrador

![](/assets/images/samba/win7-3.png)

* Reiniciar: 

![](/assets/images/samba/win7-4.png)

* Login

![](/assets/images/samba/win7-5.png)

* Usuario ema: 

![](/assets/images/samba/win7-6.png)


## COMANDOS ÚTILES:


El resto de configuraciones se pueden hacer mediante RSAT en Windows.

* Ver configuración de seguridad de los password:

```bash
samba-tool domain passwordsettings show
```

* Establecer un límite de expiración del password, sustituir **administrator** por el usuario que se desee:

```bash
samba-tool user setexpiry Administrator –days=90
```

* Definir que el password nunca expire, sustituir administrator por el usuario que desee:

```bash
samba-tool user setexpiry Administrator –noexpiry
```

* Establecer un password para un usuario determinado:

```bash
samba-tool user setpassword usuario
```

* Eliminar un usuario determinado:

```bash
samba-tool user delete usuario
```

* Deshabilitar un usuario determinado:

```bash
samba-tool user disable usuario
```

* Activar un usuario que se ha deshabilitado:

```bash
samba-tool user enable usuario
```



[Manual de Instalaci](https://samba.tranquil.it/doc/en/samba_config_server/debian/server_install_samba_debian.html)
